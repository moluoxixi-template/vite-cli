/**
 * 应用入口文件
 * 初始化 React 应用并挂载到 DOM
 */

<% if (qiankun) { -%>
import { qiankunWindow, renderWithQiankun } from 'vite-plugin-qiankun/dist/helper'
<% } -%>
import React from 'react'
import ReactDOM from 'react-dom/client'
import { RouterProvider } from 'react-router-dom'
<% if (i18n) { -%>
import '@/locales'
<% } -%>
<% if (sentry) { -%>
import { initSentry } from '@/utils/sentry'
<% } -%>
import { createRouter } from '@/router'

// 导入样式文件
<% if (uiLibrary === 'ant-design') { -%>
import 'antd/dist/reset.css'
<% } -%>
import '@/assets/styles/main.scss'
import '@/assets/fonts/index.css'

<% if (sentry) { -%>
// 初始化 Sentry
initSentry({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.MODE,
})

<% } -%>
let root: ReturnType<typeof ReactDOM.createRoot> | null = null

/**
 * 渲染应用
 * @param props 渲染属性
 */
async function render(props: Record<string, unknown> = {}): Promise<void> {
  const { container } = props as { container?: Element }
<% if (qiankun) { -%>
  const basename = qiankunWindow.__POWERED_BY_QIANKUN__
    ? (qiankunWindow as { __INJECTED_PUBLIC_PATH_BY_QIANKUN__?: string }).__INJECTED_PUBLIC_PATH_BY_QIANKUN__?.split('/')[1]
    : undefined
  const router = createRouter({ basename })
<% } else { -%>
  const router = createRouter()
<% } -%>

  const containerElement = container
    ? container.querySelector('#root') || container
    : document.getElementById('root')!

  root = ReactDOM.createRoot(containerElement)
  root.render(
    <React.StrictMode>
      <RouterProvider router={router} />
    </React.StrictMode>,
  )
}

<% if (qiankun) { -%>
if (!qiankunWindow.__POWERED_BY_QIANKUN__) {
  render({})
}
else {
  renderWithQiankun({
    async mount(props: Record<string, unknown>) {
      await render(props)
    },
    bootstrap() {},
    unmount() {
      root?.unmount()
      root = null
    },
    update() {},
  })
}
<% } else { -%>
render({})
<% } -%>

