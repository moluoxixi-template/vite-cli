/**
 * 应用入口文件 - Qiankun 微前端模式
 * 初始化 Vue 应用并挂载到 DOM（支持 qiankun 生命周期）
 */

import { qiankunWindow, renderWithQiankun } from 'vite-plugin-qiankun/dist/helper'
import { createApp } from 'vue'
import directives from '@/directives'
<% if (i18n) { -%>
import i18n from '@/locales'
<% } -%>
<% if (sentry) { -%>
import { initSentry } from '@/utils/sentry'
<% } -%>
import { store } from '@/stores'
import App from './App.vue'
import getRouter from './router'

// 导入样式文件
<% if (uiLibrary === 'element-plus') { -%>
import '@/assets/styles/element/index.scss'
import '@/assets/styles/element/fixQiankun.scss'
<% } -%>
import '@/assets/styles/main.scss'
import '@/assets/fonts/index.css'

let app: ReturnType<typeof createApp> | null = null

/**
 * 渲染应用
 * @param props 渲染属性
 */
async function render(props: Record<string, unknown> = {}): Promise<void> {
  const { container } = props as { container?: Element }
  app = createApp(App)

  directives(app)
  const router = getRouter(props)

<% if (sentry) { -%>
  initSentry(app, router, {
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: import.meta.env.MODE,
  })

<% } -%>
  app.use(store)
<% if (i18n) { -%>
  app.use(i18n)
<% } -%>
  app.use(router)
  app.config.warnHandler = () => null

  if (container) {
    const root = container.querySelector('#app')
    app.mount(root)
  }
  else {
    app.mount('#app')
  }
}

// Qiankun 生命周期
if (!qiankunWindow.__POWERED_BY_QIANKUN__) {
  // 独立运行模式
  render({})
}
else {
  // 微前端运行模式
  renderWithQiankun({
    async mount(props: Record<string, unknown>) {
      await render(props)
    },
    bootstrap() {
      console.log('[Qiankun] Vue app bootstrapped')
    },
    unmount() {
      app?.unmount()
      app = null
      console.log('[Qiankun] Vue app unmounted')
    },
    update() {
      console.log('[Qiankun] Vue app updated')
    },
  })
}

